#!/usr/bin/env bash
set -e

OS=$(cut -f2 <<<$(lsb_release -i))

# Confirm sudo
sudo echo

if [[ "$OS" = "Ubuntu" ]]; then
	VERSION=$(cut -f2 <<<$(lsb_release -r))
	export DEBIAN_FRONTEND=noninteractive

	sudo apt install -y software-properties-common
	sudo add-apt-repository ppa:neovim-ppa/unstable -y
	sudo apt update
	sudo apt upgrade -y

	if [[ "$VERSION" = "20.04" || "$VERSION" = "22.04" || "$VERSION" = "22.10" ]]; then
		sudo -E apt install -y build-essential neofetch kitty python3-pip tmux curl python3-virtualenvwrapper fd-find telegram-desktop htop systemd-coredump zsh bat unar neovim unzip
	else
		echo "Unknown Ubuntu"
		exit 1
	fi

	if [[ "$VERSION" = "22.04" || "$VERSION" = "22.10" ]]; then
		sudo apt install -y zoxide exa
	fi

	sudo apt autoremove -y
	curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
	/home/astadnik/.cargo/bin/rustup default stable

	cd /tmp
	curl -LO https://github.com/r-darwish/topgrade/releases/latest/download/topgrade-v9.0.1-x86_64-unknown-linux-gnu.tar.gz
	tar xf topgrade-*
	sudo mv topgrade /usr/local/bin
	rm -rf topgrade-*

	sudo update-alternatives --set x-terminal-emulator /usr/bin/kitty

	if [[ "$(command -v gnome-shell)" ]]; then
		sudo -E apt install -y gnome-tweaks chrome-gnome-shell gtk2-engines-murrine gnome-themes-extra sassc

		cd /tmp
		wget -O gnome-shell-extension-installer "https://github.com/brunelli/gnome-shell-extension-installer/raw/master/gnome-shell-extension-installer"
		chmod +x gnome-shell-extension-installer
		sudo mv gnome-shell-extension-installer /usr/bin/

		gnome-shell-extension-installer 19 307 3193

		if [[ ! -d ~/.themes ]]; then
			cd /tmp
			git clone https://github.com/vinceliuice/Colloid-icon-theme
			cd Colloid-icon-theme/
			./install.sh -s nord
		fi

		if [[ ! -d ~/.icons ]]; then
			cd /tmp
			git clone https://github.com/vinceliuice/Colloid-gtk-theme
			cd Colloid-gtk-theme/
			./install.sh --tweaks nord
		fi

		if [[ ! -d ~/.fonts ]]; then
			cd /tmp
			curl -LO https://github.com/ryanoasis/nerd-fonts/releases/download/v2.1.0/JetBrainsMono.zip
			unar JetBrainsMono.zip
			rm -rf ~/.fonts
			mkdir ~/.fonts
			mv /tmp/JetBrainsMono/*.ttf ~/.fonts/
			fc-cache -fv
		fi

		cd /tmp
		wget -cO- https://github.com/phisch/phinger-cursors/releases/latest/download/phinger-cursors-variants.tar.bz2 | tar xfj - -C ~/.icons

		cd /tmp
		wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
		sudo apt install ./google-chrome-stable_current_amd64.deb
		rm -rf ./google-chrome-stable_current_amd64.deb

		gsettings set org.gnome.desktop.background picture-uri-dark file:///home/astadnik/Pictures/watchtower.jpg
	fi

elif [[ "$OS" = "EndeavourOS" || "$OS" = "Arch" ]]; then
	sudo pacman -Syu --noconfirm --needed git base-devel
	git clone https://aur.archlinux.org/yay.git
	cd yay
	makepkg -sri --needed --noconfirm
	cd ..
	rm -rf .cache yay

	yay -Sy --noconfirm --answerdiff=None rustup
	rustup default stable

	yay -Sy --noconfirm --answerdiff=None git neofetch neovim python-pip tmux curl python-virtualenvwrapper fd exa telegram-desktop htop zsh zoxide bat pyright rust-analyzer openssh python-pip neovim-remote unzip npm figlet topgrade

	if [[ "$(command -v gnome-shell)" ]]; then
		yay -Sy --noconfirm --answerdiff=None gnome-tweaks gnome-shell-extension-installer colloid-icon-theme-git colloid-gtk-theme-git phinger-cursors google-chrome kitty nerd-fonts-jetbrains-mono

		gsettings set org.gnome.desktop.background picture-uri-dark file:///home/astadnik/Pictures/watchtower.jpg
	fi

else
	echo "Unknown distro"
	exit 1
fi

git config --global url."https://github.com/".insteadOf 'git@github.com:'
yadm submodule update --init --recursive
git config --global user.email "stadnikandriy1@gmail.com"
git config --global user.name "Stadnik Andrii"

~/.local/bin/theme_switch || true

ssh-keygen -t ed25519 -q -N "" -f ~/.ssh/id_ed25519

export TMUX_PLUGIN_MANAGER_PATH='$HOME/.tmux/plugins/'
git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# ~/.tmux/plugins/tpm/bin/install_plugins

# Install Packer
topgrade -y
